<!DOCTYPE html>
<html>
<head>
    <title>Access Plan to Tree Formatter</title>

    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.no-icons.min.css"
          rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.1.1/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="https://rawgithub.com/Shiti/queralyzerUI/master/css/queralyzer.css">
    <link rel="stylesheet" href="css/formatter.css">
    <link rel="stylesheet" href="https://rawgithub.com/Shiti/queralyzerUI/master/codemirror/codemirror.css">
    
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/codemirror/codemirror.js"></script>
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/codemirror/sql.js"></script>
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/codemirror/placeholder.js"></script>
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/js/lib/d3.min.js" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/js/app/TypeFactory.js" type="text/javascript"></script>
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/js/app/ExplainTree.js" type="text/javascript"></script>
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/js/app/App.js" type="text/javascript"></script>
    <script src="https://rawgithub.com/Shiti/queralyzerUI/master/bootstrap/js/bootstrap.min.js"
            type="text/javascript"></script>
    <script src="js/app/Formatter.js" type="text/javascript"></script>

<script type="text/javascript">
	$(function() {

		var sampleaccessplan = "id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra    \n1	SIMPLE	ur	system	(null)	(null)	(null)	(null)	1	(null)    \n1	SIMPLE	b	const	PRIMARY	PRIMARY	4	const	1	(null)    \n1	SIMPLE	p	ref	i2	i2	4	const	1	(null)";
		var withprefex = "Below is the sample Access plan :\n" + sampleaccessplan;
		var placeholderplan = "- Join using bookmark lookup(index lookup)<br>&nbsp;&nbsp;- Join using bookmark lookup(index lookup) [1]<br>&nbsp;&nbsp;&nbsp;- Join [5]<br>&nbsp;&nbsp;&nbsp;&nbsp;Filter on p [6]<br>&nbsp;&nbsp;&nbsp;&nbsp;Filter on e [6]<br>&nbsp;&nbsp;&nbsp;- Join [5]<br>&nbsp;&nbsp;&nbsp;&nbsp;Filter on p [7]<br>&nbsp;&nbsp;&nbsp;&nbsp;Filter on e [7]<br>&nbsp;&nbsp;- Join using bookmark lookup(index lookup) [1]<br>&nbsp;&nbsp;&nbsp;- Join [2]<br>&nbsp;&nbsp;&nbsp;&nbsp;- Join<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter on b [3]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter on p [3]<br>&nbsp;&nbsp;&nbsp;&nbsp;Filter on ur [3]<br>&nbsp;&nbsp;&nbsp;&nbsp;- Join [2]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Join<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter on b [4]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter on p [4]<br>&nbsp;&nbsp;&nbsp;&nbsp;Filter on ur [4]<br>";
		
		$(".container-fluid").height(window.innerHeight - 41 + "px");
		$(".queryEditor").height($(".container-fluid").height() - 50 + "px");
		$(".tree").height($(".container-fluid").height() - 50 + "px");
		$("#accessplanparent").height($(".queryEditor").height() + "px");
		$("#accessplandata").height(($("#accessplanparent").height() - 58) + "px");
		$(".accessplan").height($("#accessplandata").height() - 130 + "px");
		
		$(".result").height(window.innerHeight * 0.8 + "px");
		$("#treeContainer").height(($(".tree").height() - 78) + "px");
		$("#rowContainer").height(($(".tree").height() - 78) + "px");
		$("#help").height(($(".tree").height() - 78) + "px");
		
		var formatter = queralyzer.Formatter;
		var editor = formatter.getCodeMirrorEditor("#userQuery");
		formatter.initializeEditor(editor);
		formatter.formatToTree(sampleaccessplan);
	
		$('#reset').click(function(e) {
			e.preventDefault();
			formatter.reset();
			editor.setValue("");
		});

		$('#fileupload').on('change', function() {
			var files;
			
			$('#info').empty();
			files = document.getElementById('fileupload').files;
			if (!files.length) {
				alert('Please select a file!');
				return false;
			}
			formatter.readfile(files[0]);
		});

		$('#submitButton')
				.click(
						function(e) {
							var accessplan;
							
							accessplan = $(".accessplan")[0].value;
							e.preventDefault();
							$('#info').empty();
							$("#treeContainer").empty();
							$("#rowContainer").empty();
							if (accessplan === ""
									|| accessplan === sampleaccessplan) {
								$('#info')
										.html(
												"Error : Empty access plan could not be formatted!!!");
								return false;
							}
							formatter.formatToTree(accessplan);
							for(var i=0; i<$(".leaves").length ; i++)
								{
								$(".leaves")[i].style.color = "black";
								}
							$(".table-condensed")[0].style.color = "black";
							
						});

		$("#help")
		.load(
				"https://rawgithub.com/Shiti/queralyzerUI/master/data/help.html");
		
		$('#browse').click(function() {
			$('#fileupload').trigger('click');
		});
		
		$('#queryplantab').click(function() {
			$('#submitButton')[0].disabled = true;
		});

		$('#accessplantab').click(function() {
			$('#submitButton')[0].disabled = false;
		});

		$('#accessplantextarea').attr('value', withprefex);

		$('#accessplantextarea').focus(function() {
			if ($(this).val() === withprefex) {
				$(this).attr('value', '');
			}
			$(".accessplan")[0].style.color = "black";
		});

		$('#accessplantextarea').blur(function() {
			if ($(this).val() === '') {
				$(".accessplan")[0].style.color = "#808080";
				$(this).attr('value', withprefex);
			}
		});
		$('#accessplantextarea').blur();

		$('#browse').focus();
		
		$(document).on("keydown", function (e) {
		    if (e.which === 8 ) {
		        e.preventDefault();
		        $('#browse').focus();
		    }
		});
		
	});
	
	
	
</script>
</head>
<body >
<header>
    <div class="headerWrapper">
        <img src="https://rawgithub.com/Shiti/queralyzerUI/master/img/pramati.png" style="height:24px;float:left;">
        <a class="logo" href="index.html"></a>
    </div>
</header>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span5">
            <div class="boxed queryEditor">
							<span class="add-on" data-toggle="tooltip" title="Run to format given access plan into tree structure">
							<button id="submitButton" style="margin-top: 5px;"
								class="pull-right btn btn-success">
								Run<i class="icon-play icon-white" ></i> 
							</button></span>
							<span class="add-on" data-toggle="tooltip" title="Reset all fields to default values">
							<button id="reset" style="margin-top: 5px; margin-right: 3px;"
								class="btn btn-primary pull-right">
								<i class="icon-repeat icon-white" ></i>  Reset</button>
						    </span>
						<div class="tabbable" id="accessplanparent">
							<ul class="nav nav-tabs">
								<li class="active" tabindex="2"><a href="#accessplandata" data-toggle="tab"
									id="accessplantab">Access Plan</a></li>
								<li><a href="#queryplandata" data-toggle="tab"
									id="queryplantab">Query</a></li>
							</ul>
							<div class="tab-content" id="tab-content">
								<div class="tab-pane active" id="accessplandata">
									<span class="add-on" data-toggle="tooltip" title="Paste your access plan here"><textarea name="accessplan" class="accessplan"
										id="accessplantextarea"></textarea></span>
									<input name="fileupload" type="file" id="fileupload" style="position:absolute; top:-100px;">
									<span class="add-on" data-toggle="tooltip" title="Upload your file which have access plan"> 
									<button id="browse" class="btn btn-primary pull-right"  ><i class="icon-upload icon-white" style="zoom: 1.3; -moz-transform: scale(1.3);"></i> Upload
									</button>
									</span>
									<div id="info"></div>
								</div>
								<div class="tab-pane" id="queryplandata">
									<form id="queryForm">
										<span class="add-on" data-toggle="tooltip" title="Paste your query here so that it is easier to correlate with access plan"><textarea id="userQuery" name="query"          
											placeholder="Here is the sample query which is used to correlate with access plan : select count(distinct b.id_1) as value, p.name, p.id_1  from x_booking b, x_property p, x_upgrade_request ur where b.property_id = p.id_1 and b.id_1 = ur.booking_id  group by b.property_id;"></textarea></span>
									</form>
								</div>
							</div>
						</div>
				</div>
        </div>
        <div class="span7" style="margin-left: 0.5%;">
            <div id="result" class="boxed tree">
                <div class="tabbable">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#treeContainer" data-toggle="tab">Tree View</a></li>
                        <li><a href="#rowContainer" data-toggle="tab">Grid View</a></li>
                        <li><a href="#help" data-toggle="tab">Help</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active result" id="treeContainer">
                        </div>
                        <div class="tab-pane result" id="rowContainer">
                        </div>
                        <div class="tab-pane result" id="help">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
